title: 了解paxos：保证进展
author: gsal
tags:
  - 区块链
categories: []
date: 2018-03-26 19:22:00
---
[understanding paxos](https://understandingpaxos.wordpress.com/)的学习笔记。
#### 面临的问题
当我们确保了集群最终会到达一个共识值的时候，但却没有考虑到这个集群可能不会在达成共识上有进展。常见的导致无进展的情况有两种：
1. 节点间的干扰  
1. 节点的宕机  
<!--more-->
#### 节点间的干扰
比如考虑一种情况：
1. 当A提出了(1,A)的请求消息并得到批准
1. B提出了(2,B)的请求消息并得到了批准
1. A提出提议消息被否定
1. A提出(3,A)的请求消息
1. B提出提议被否定
1. B提出(4，B)的请求消息
1. ...  

可以一直这样循环下去。这样就不会产生任何进展。我们要尽可能避免这种情况的发生。采用的方法为**指数回退法**（exponential backoff approach）。每一个节点从一个小的重传窗口开始，比如2ms，每接收到一次Nack消息就将窗口翻倍，要重新提出请求消息的时候，就从0-窗口值中随机选择一个数，然后延迟这么长再开始操作。这样做有两个好处：

1. 随机化可以防止可能导致连续冲突的同步延迟
1. 不断增加的窗口大小可以保证最后一个节点总有足够的时间来完成这整个共识过程

#### 节点宕机
我们希望，在一个达成共识的过程中，只有部分节点在推进这个过程，如果所有节点都参与就会变得非常拥挤。最好是当原本在推进这个过程的结点宕机了之后，由新的节点补充进来，继续这个工作。因此，我们可以有最直接的设想即**当超过一定时长没有接到请求许可消息或者提议消息，则开始推进**。但由于是确定的时间长度，在推进的节点宕机之后，过了这个时间就会有大量的节点开始推进，导致大量的冲突和干扰。因此这个值最好是一个范围内的随机值，比如在局域网的低延迟应用可能选用2-10ms而基于互联网的高延迟应用可能就是2-5s。