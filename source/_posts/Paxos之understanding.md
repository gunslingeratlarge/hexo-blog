title: 了解paxos：形成共识
author: gsal
tags:
  - paxos
  - 分布式
  - 区块链
categories:
  - 区块链
date: 2018-03-22 07:08:00
---
前面有部分内容待补充...
##### 负面反馈
就是说在提出提议的时候，节点的提议可能由于它自身的suggestion ID太小而被忽略，但是它不知道它的提议被忽略，只能靠超时、重发等机制发现可能自己的提议无法达成共识，然后再增大suggestion ID。如果有负面反馈，即如果来自另一个节点的提议没有被接受，即向该节点发送“你的提议未被我接受”的消息，这样当收到网络中超过半数的负面回馈时，该节点就知道它的提议没有可能达成共识了，可以更早地增大suggestion ID，开始下一轮的提议。
<!--more-->

#### 达成一致

注意：这里我们对一些术语进行定义  
+ 权限请求消息：指一个节点向其他节点发送请求，以使他们允许自己进行提议，这条消息也会附带一个id，但是不是消息本身的id，而是如果得到批准的话，将发送的提议消息的提议id
+ 许可/批准：指一个节点批准另一个节点发送的权限请求消息，从而可以向自己发送提议消息
+ 提议消息：提出一个值和一个提议Id，并希望在这个值上达成一致
+ 已批准消息：指一个节点当前最新批准的消息，是该节点所收到所有权限请求消息中的提议id最大的消息
+ 接受：特指接受提议消息，并不会**接受**权限请求消息，而是**许可/批准**权限请求消息  
分为两步：  
Step 1：节点尝试发送权限请求消息，如果超过半数的结点都给了它许可了，那么它可以进入第二步。如果没有，就增大自己想提出的suggestion的ID，再重新发送权限请求消息  
Step 2：获得许可之后，节点提出提议，如果被超过半数的结点接受，那么就达成了一致  
对这两个步骤再详细分析一下，在Step 1中，这个suggestion ID的大小是所有节点全局共用还是每个节点自己有一个suggestion ID的大小呢？答案是自己维护一个suggestion ID的大小，因为如果全局共用你很难获知别的结点的suggestion ID发到什么号了，你甚至还要去同步这个ID，使得整个集群对ID的认识保持一致。如果各管各的就很方便了，我们只要能够保证两个ID能够比较出大小就可以了（如3 B > 3 A > 2 A）。   
结点是怎么接受一个提议的？当这个提议已经被许可了之后，而且在许可到接受这段时间内这个结点没有批准别的结点进行提议，也就是说，如果提议消息的id等于已批准消息的id，就可以接受这个提议。还有一种情况就是提议消息的id>已批准消息的id，这种情况会直接接受提议的，这一点需要注意一下。   

##### 消息处理规则  
**当一个节点收到一条权限请求消息的时候**：  
如果说之前没有接受到任何的权限请求消息，那么就批准这条权限请求消息。如果说这个节点之前已经有批准的消息了，就比较这条新的消息和它已经批准了的消息谁大，如果新的消息大，那么就批准新的消息，此时旧的已批准消息就无效了。如果新的消息小，那么就忽略它或者发送负面反馈。  
**当一个节点收到一条提议消息的时候**：  
如果这条提议消息的提议id和这个节点的已批准消息的id一致（或者更大），那么这个节点就接受这个提议。除此之外，都不接受。  
**如何提出提议**：  
当一个节点获得了超半数的结点批准可以进行提议时，这个节点就可以着手进行提议了。对这个节点来说，提议id是好确定的，因为id是依次增大的，比如A节点，id就从1 A 到 2 A 到3 A...依次增大，并且已经在权限请求消息中带上了提议id。问题在于如何确定提议消息中要携带的企图达成一致的值。在讲述之前我们需要补充的是，每一个节点收到权限请求消息之后，如果它要批准这条消息，除了返回一个“yes”之外，还要携带上它已经接受了的一系列消息的最大id（如果有的话），这是为了使得发送权限请求消息的提议者能够从这些已经被接受了的消息中选择值，而不是自己提出一个新值，选择值的策略依然是最大id。  
因此现在我们来着手提议。假设我这个节点A发送的权限请求消息(3 A)得到了另外两个个节点B和C的批准，但是节点B同时也告诉我们B接受了id为(2 C)的这个提议消息，值为"git",节点C告诉我们C接受了id为(1 B)的提议消息，值为"hub"，因此我们的节点A手上有：
1. 能够提出提议消息的权利，并且这个提议消息的id是(3 A)
1. B告诉的(2 C git)和C告诉的(1 B hub)这两条已被接收消息的**信息**  

现在A只能从(2 C git)和(1 B hub)中选择一个，按照最大id的策略，选择(2 C git)，则A的消息的值为git，因此A将它的提议消息(3 A git)向所有节点发送，尝试形成共识值。  
到现在，A的提议就完成了。